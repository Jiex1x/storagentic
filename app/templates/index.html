<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stor-a-gentic - Your Storage Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Stor-a-gentic</h1>
            <p class="text-gray-600">Your Intelligent Storage Assistant</p>
        </header>

        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <div id="chat-messages" class="space-y-4 mb-4 h-96 overflow-y-auto">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="flex space-x-2">
                <input type="text" id="message-input" 
                       class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Type your question...">
                <button onclick="sendMessage()" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 focus:outline-none">
                    Send
                </button>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
                <button onclick="askQuestion('What size storage unit do I need?')" 
                        class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">
                    Storage Unit Size
                </button>
                <button onclick="showBookingModal()" 
                        class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">
                    Book Service
                </button>
                <button onclick="askQuestion('Where is your nearest facility?')" 
                        class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">
                    Find Location
                </button>
            </div>
        </div>
    </div>

    {% include 'booking_form.html' %}

    <script>
        function addMessage(message, isUser = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            messageDiv.innerHTML = `
                <div class="max-w-3/4 ${isUser ? 'bg-blue-500 text-white' : 'bg-gray-200'} rounded-lg px-4 py-2">
                    ${message}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, true);
            input.value = '';
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addMessage(data.response);
                } else {
                    addMessage('Sorry, an error occurred. Please try again later.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Sorry, an error occurred. Please try again later.');
            });
        }

        function askQuestion(question) {
            document.getElementById('message-input').value = question;
            sendMessage();
        }

        // Booking related functions
        function showBookingModal() {
            document.getElementById('bookingModal').classList.remove('hidden');
            
            // Set date constraints
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 14);
            
            // Format dates for input
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const dateInput = document.getElementById('bookingDate');
            dateInput.min = formatDate(tomorrow);
            dateInput.max = formatDate(maxDate);
            dateInput.value = formatDate(tomorrow);
            
            // Load initial time slots
            updateTimeSlots(dateInput.value);
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingError').classList.add('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('bookingError');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('bookingError').classList.add('hidden');
        }

        function updateTimeSlots(date) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const timeSlotSelect = document.getElementById('timeSlot');
            const submitButton = document.getElementById('submitButton');
            
            loadingIndicator.classList.remove('hidden');
            timeSlotSelect.disabled = true;
            submitButton.disabled = true;
            
            fetch(`/booking/available-slots?start_date=${date}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        timeSlotSelect.innerHTML = '<option value="">Select a time slot</option>';
                        
                        if (data.slots.length === 0) {
                            timeSlotSelect.innerHTML += '<option value="" disabled>No available slots for this date</option>';
                        } else {
                            data.slots.forEach(slot => {
                                const time = new Date(slot);
                                if (!isNaN(time.getTime())) {  // Check if date is valid
                                    const option = document.createElement('option');
                                    option.value = slot;
                                    option.textContent = time.toLocaleTimeString([], { 
                                        hour: '2-digit', 
                                        minute: '2-digit',
                                        hour12: true 
                                    });
                                    timeSlotSelect.appendChild(option);
                                }
                            });
                        }
                    } else {
                        showError('Error loading time slots. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching time slots:', error);
                    showError('Error loading time slots. Please try again.');
                })
                .finally(() => {
                    loadingIndicator.classList.add('hidden');
                    timeSlotSelect.disabled = false;
                    submitButton.disabled = false;
                });
        }

        // Set up event listeners
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('bookingDate').addEventListener('change', function(e) {
            hideError();
            updateTimeSlots(e.target.value);
        });

        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            hideError();
            
            const submitButton = document.getElementById('submitButton');
            const formData = {
                start_time: document.getElementById('timeSlot').value,
                name: document.getElementById('name').value.trim(),
                contact: document.getElementById('contact').value.trim(),
                address: document.getElementById('address').value.trim()
            };

            // Basic validation
            if (!formData.name) {
                showError('Please enter your name');
                return;
            }
            if (!formData.contact) {
                showError('Please enter your contact information');
                return;
            }
            if (!formData.address) {
                showError('Please enter the collection address');
                return;
            }
            if (!formData.start_time) {
                showError('Please select a time slot');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Booking...</span>
                </div>
            `;

            fetch('/booking/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    closeBookingModal();
                    document.getElementById('successModal').classList.remove('hidden');
                    document.getElementById('bookingForm').reset();
                } else {
                    showError(data.message || 'Error creating booking. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('An error occurred while creating the booking. Please try again.');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = 'Book Now';
            });
        });
    </script>
</body>
</html> 